<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Timemark Pro</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: Arial, sans-serif;
}
.container {
  padding: 10px;
}
input, button {
  width: 100%;
  margin: 6px 0;
  padding: 10px;
  background: #111;
  color: #fff;
  border: 1px solid #00eaff;
  border-radius: 6px;
}
canvas {
  width: 100%;
  border-radius: 10px;
  margin-top: 10px;
}
#map {
  height: 180px;
  border-radius: 8px;
  border: 1px solid #00eaff;
}
label {
  font-size: 12px;
}
</style>
</head>

<body>
<div class="container">

<input type="file" accept="image/*" id="photoInput">

<label>Ukuran Jam</label>
<input type="range" id="jamSize" min="60" max="140" value="110">

<label>Ukuran Teks Detail</label>
<input type="range" id="textSize" min="16" max="32" value="22">

<label>Ukuran Map</label>
<input type="range" id="mapSize" min="120" max="260" value="180">

<button onclick="initGPS()">Ambil Lokasi</button>

<div id="map"></div>

<button onclick="drawOverlay()">Terapkan</button>
<button onclick="download()">Download PNG</button>

<canvas id="canvas"></canvas>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let img = new Image();

let map, marker;
let loc = {};

document.getElementById("photoInput").onchange = e => {
  img.src = URL.createObjectURL(e.target.files[0]);
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);
  };
};

function initGPS() {
  navigator.geolocation.getCurrentPosition(pos => {
    loc.lat = pos.coords.latitude;
    loc.lng = pos.coords.longitude;
    loc.alt = pos.coords.altitude
      ? pos.coords.altitude.toFixed(1) + " m"
      : "-";

    initMap(loc.lat, loc.lng);
    reverseGeo(loc.lat, loc.lng);
  });
}

function initMap(lat, lng) {
  if (map) map.remove();

  map = L.map("map").setView([lat, lng], 18);

  // SATELIT
  L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
  ).addTo(map);

  marker = L.marker([lat, lng], { draggable: true }).addTo(map);
  marker.on("dragend", () => {
    const p = marker.getLatLng();
    reverseGeo(p.lat, p.lng);
  });
}

async function reverseGeo(lat, lng) {
  loc.lat = lat;
  loc.lng = lng;

  const r = await fetch(
    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
  );
  const d = await r.json();
  loc.addr = d.display_name || "-";
}

function drawOverlay() {
  ctx.drawImage(img, 0, 0);

  const jamSize = +jamSizeEl.value;
  const textSize = +textSizeEl.value;
  const mapBox = +mapSizeEl.value;

  const now = new Date();
  const jam = now.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });
  const tanggal = now.toLocaleDateString("id-ID");
  const hari = now.toLocaleDateString("id-ID", { weekday: "long" });

  ctx.fillStyle = "rgba(0,0,0,0.6)";
  ctx.fillRect(20, canvas.height - 360, canvas.width - 40, 340);

  ctx.fillStyle = "#fff";
  ctx.font = `${jamSize}px Arial`;
  ctx.fillText(jam, 40, canvas.height - 300);

  ctx.font = `${textSize}px Arial`;
  ctx.fillText(`${tanggal}`, 40, canvas.height - 250);
  ctx.fillText(`${hari}`, 40, canvas.height - 220);
  ctx.fillText(loc.addr || "-", 40, canvas.height - 180);
  ctx.fillText(`Koordinat: ${loc.lat.toFixed(6)}, ${loc.lng.toFixed(6)}`, 40, canvas.height - 140);
  ctx.fillText(`Ketinggian: ${loc.alt}`, 40, canvas.height - 110);

  // MAP PREVIEW
  ctx.strokeStyle = "#00eaff";
  ctx.strokeRect(
    canvas.width - mapBox - 30,
    canvas.height - mapBox - 40,
    mapBox,
    mapBox
  );
}

function download() {
  const a = document.createElement("a");
  a.download = "timemark.png";
  a.href = canvas.toDataURL("image/png");
  a.click();
}

const jamSizeEl = document.getElementById("jamSize");
const textSizeEl = document.getElementById("textSize");
const mapSizeEl = document.getElementById("mapSize");
</script>
</body>
</html>
