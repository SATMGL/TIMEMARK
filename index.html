<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Timemark Lapangan</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">

<style>
body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: Arial, sans-serif;
}
.container {
  padding: 10px;
}
input, button {
  width: 100%;
  margin: 6px 0;
  padding: 10px;
  background: #111;
  color: #fff;
  border: 1px solid #00eaff;
  border-radius: 6px;
}
canvas {
  width: 100%;
  margin-top: 10px;
  border-radius: 10px;
}
#map {
  height: 260px;
  border-radius: 10px;
  border: 1px solid #00eaff;
}
label {
  font-size: 12px;
}
</style>
</head>

<body>
<div class="container">

<input type="file" accept="image/*" id="photoInput">

<label>Ukuran Jam</label>
<input type="range" id="jamSize" min="60" max="140" value="110">

<label>Ukuran Teks</label>
<input type="range" id="textSize" min="16" max="30" value="22">

<label>Ukuran Map</label>
<input type="range" id="mapSize" min="120" max="260" value="180">

<button onclick="initGPS()">Ambil Lokasi GPS</button>

<div id="map"></div>

<button onclick="drawOverlay()">Terapkan ke Foto</button>
<button onclick="download()">Download PNG</button>

<canvas id="canvas"></canvas>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let img = new Image();

let map, marker;
let loc = {};
let mapImage = new Image();

document.getElementById("photoInput").onchange = e => {
  img.src = URL.createObjectURL(e.target.files[0]);
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);
  };
};

function initGPS() {
  navigator.geolocation.getCurrentPosition(pos => {
    loc.lat = pos.coords.latitude;
    loc.lng = pos.coords.longitude;
    loc.alt = pos.coords.altitude
      ? pos.coords.altitude.toFixed(1) + " m"
      : "-";
    initMap(loc.lat, loc.lng);
    reverseGeo(loc.lat, loc.lng);
  });
}

function initMap(lat, lng) {
  if (map) map.remove();

  map = L.map("map").setView([lat, lng], 18);

  // SATELIT STABIL
  L.tileLayer(
    "https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",
    { maxZoom: 20 }
  ).addTo(map);

  marker = L.marker([lat, lng], { draggable: true }).addTo(map);
  marker.on("dragend", () => {
    const p = marker.getLatLng();
    reverseGeo(p.lat, p.lng);
    updateStaticMap(p.lat, p.lng);
  });

  // SEARCH LOKASI
  L.Control.geocoder({
    defaultMarkGeocode: false
  }).on("markgeocode", e => {
    const p = e.geocode.center;
    map.setView(p, 18);
    marker.setLatLng(p);
    reverseGeo(p.lat, p.lng);
    updateStaticMap(p.lat, p.lng);
  }).addTo(map);

  updateStaticMap(lat, lng);
}

async function reverseGeo(lat, lng) {
  loc.lat = lat;
  loc.lng = lng;
  const r = await fetch(
    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
  );
  const d = await r.json();
  loc.addr = d.display_name || "-";
}

function updateStaticMap(lat, lng) {
  const size = 300;
  mapImage.src =
    `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}` +
    `&zoom=18&size=${size}x${size}&maptype=satellite&markers=color:red|${lat},${lng}`;
}

function drawOverlay() {
  ctx.drawImage(img, 0, 0);

  const jamSize = +jamSizeEl.value;
  const textSize = +textSizeEl.value;
  const mapBox = +mapSizeEl.value;

  const now = new Date();
  const jam = now.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });
  const tanggal = now.toLocaleDateString("id-ID");
  const hari = now.toLocaleDateString("id-ID", { weekday: "long" });

  ctx.fillStyle = "rgba(0,0,0,0.6)";
  ctx.fillRect(20, canvas.height - 380, canvas.width - 40, 360);

  ctx.fillStyle = "#fff";
  ctx.font = `${jamSize}px Arial`;
  ctx.fillText(jam, 40, canvas.height - 300);

  ctx.font = `${textSize}px Arial`;
  ctx.fillText(`${tanggal} â€¢ ${hari}`, 40, canvas.height - 250);
  ctx.fillText(loc.addr || "-", 40, canvas.height - 210);
  ctx.fillText(`Koordinat: ${loc.lat.toFixed(6)}, ${loc.lng.toFixed(6)}`, 40, canvas.height - 170);
  ctx.fillText(`Ketinggian: ${loc.alt}`, 40, canvas.height - 140);

  // MINI MAP
  if (mapImage.complete) {
    ctx.drawImage(
      mapImage,
      canvas.width - mapBox - 30,
      canvas.height - mapBox - 40,
      mapBox,
      mapBox
    );
  }
}

function download() {
  const a = document.createElement("a");
  a.download = "timemark.png";
  a.href = canvas.toDataURL("image/png");
  a.click();
}

const jamSizeEl = document.getElementById("jamSize");
const textSizeEl = document.getElementById("textSize");
const mapSizeEl = document.getElementById("mapSize");
</script>
</body>
</html>
