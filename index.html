<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Timemark Final</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: Arial, sans-serif;
}
.container { padding: 10px; }
input, button {
  width: 100%;
  margin: 6px 0;
  padding: 10px;
  background: #111;
  color: #fff;
  border: 1px solid #00eaff;
  border-radius: 6px;
}
#map {
  height: 260px;
  border-radius: 10px;
  border: 1px solid #00eaff;
}
canvas {
  width: 100%;
  margin-top: 10px;
  border-radius: 10px;
}
</style>
</head>

<body>
<div class="container">

<input type="file" accept="image/*" id="photoInput">

<label>Tanggal & Jam</label>
<input type="datetime-local" id="timeInput">

<label>Cari Lokasi</label>
<input type="text" id="searchInput" placeholder="contoh: Jl Karang Duren Magelang">
<button onclick="searchLocation()">Cari Lokasi</button>

<div id="map"></div>

<button onclick="apply()">TERAPKAN KE FOTO</button>
<button onclick="download()">DOWNLOAD PNG</button>

<canvas id="canvas"></canvas>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let img = new Image();

let map, marker;
let loc = {};

document.getElementById("photoInput").onchange = e => {
  img.src = URL.createObjectURL(e.target.files[0]);
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);
  };
};

// INIT MAP
map = L.map("map").setView([-7.5, 110], 6);
L.tileLayer("https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}", {
  maxZoom: 20
}).addTo(map);

marker = L.marker([-7.5, 110], { draggable: true }).addTo(map);
marker.on("dragend", e => {
  const p = e.target.getLatLng();
  reverseGeo(p.lat, p.lng);
});

// SEARCH
async function searchLocation() {
  const q = searchInput.value;
  const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
  const d = await r.json();
  if (!d.length) return alert("Lokasi tidak ditemukan");

  const lat = +d[0].lat;
  const lng = +d[0].lon;

  map.setView([lat, lng], 18);
  marker.setLatLng([lat, lng]);
  reverseGeo(lat, lng);
}

async function reverseGeo(lat, lng) {
  loc.lat = lat;
  loc.lng = lng;
  const r = await fetch(
    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
  );
  const d = await r.json();
  loc.addr = d.display_name || "-";
}

// APPLY
async function apply() {
  if (!img.src) return;

  ctx.drawImage(img, 0, 0);

  // SCREENSHOT MAP
  const mapCanvas = await html2canvas(document.getElementById("map"), {
    useCORS: true
  });

  // DRAW MAP KE FOTO
  const mapSize = 260;
  ctx.drawImage(
    mapCanvas,
    canvas.width - mapSize - 30,
    canvas.height - mapSize - 30,
    mapSize,
    mapSize
  );

  // TIME
  const d = timeInput.value ? new Date(timeInput.value) : new Date();
  const jam = d.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });
  const tanggal = d.toLocaleDateString("id-ID");
  const hari = d.toLocaleDateString("id-ID", { weekday: "long" });

  // BACKGROUND
  ctx.fillStyle = "rgba(0,0,0,0.6)";
  ctx.fillRect(20, canvas.height - 320, canvas.width - 40, 290);

  // TEXT BESAR
  ctx.fillStyle = "#fff";
  ctx.font = "110px Arial";
  ctx.fillText(jam, 40, canvas.height - 210);

  ctx.font = "26px Arial";
  ctx.fillText(`${tanggal} â€¢ ${hari}`, 40, canvas.height - 170);
  ctx.fillText(loc.addr || "-", 40, canvas.height - 130);
  ctx.fillText(
    `Koordinat: ${loc.lat?.toFixed(6)}, ${loc.lng?.toFixed(6)}`,
    40,
    canvas.height - 95
  );
}

// DOWNLOAD
function download() {
  const a = document.createElement("a");
  a.download = "timemark.png";
  a.href = canvas.toDataURL("image/png");
  a.click();
}
</script>
</body>
</html>
