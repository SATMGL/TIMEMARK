<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Timemark Simple</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: Arial, sans-serif;
}
.container {
  padding: 10px;
}
input, button {
  width: 100%;
  margin: 6px 0;
  padding: 10px;
  background: #111;
  color: #fff;
  border: 1px solid #00eaff;
  border-radius: 6px;
}
#map {
  height: 260px;
  border-radius: 10px;
  border: 1px solid #00eaff;
}
canvas {
  width: 100%;
  margin-top: 10px;
  border-radius: 10px;
}
label {
  font-size: 13px;
}
.row {
  display: flex;
  gap: 6px;
}
.row input {
  flex: 1;
}
</style>
</head>

<body>
<div class="container">

<input type="file" accept="image/*" id="photoInput">

<label>Tanggal & Jam</label>
<input type="datetime-local" id="timeInput">

<label>Cari Lokasi</label>
<input type="text" id="searchInput" placeholder="contoh: Jl. Karang Duren Magelang">
<button onclick="searchLocation()">Cari</button>

<div id="map"></div>

<button onclick="apply()">Terapkan ke Foto</button>
<button onclick="download()">Download PNG</button>

<canvas id="canvas"></canvas>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let img = new Image();

let map, marker;
let loc = {};

document.getElementById("photoInput").onchange = e => {
  img.src = URL.createObjectURL(e.target.files[0]);
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);
  };
};

// INIT MAP (default Indonesia)
map = L.map("map").setView([-7.5, 110], 6);

// SATELIT (STABIL)
L.tileLayer(
  "https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",
  { maxZoom: 20 }
).addTo(map);

marker = L.marker([-7.5, 110], { draggable: true }).addTo(map);

marker.on("dragend", () => {
  const p = marker.getLatLng();
  loc.lat = p.lat;
  loc.lng = p.lng;
  reverseGeo(p.lat, p.lng);
});

// SEARCH LOKASI
async function searchLocation() {
  const q = document.getElementById("searchInput").value;
  if (!q) return;

  const r = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&q=${q}`
  );
  const d = await r.json();
  if (!d.length) return alert("Lokasi tidak ditemukan");

  const lat = parseFloat(d[0].lat);
  const lng = parseFloat(d[0].lon);

  map.setView([lat, lng], 18);
  marker.setLatLng([lat, lng]);

  reverseGeo(lat, lng);
}

// REVERSE ALAMAT
async function reverseGeo(lat, lng) {
  loc.lat = lat;
  loc.lng = lng;

  const r = await fetch(
    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
  );
  const d = await r.json();
  loc.addr = d.display_name || "-";
}

// APPLY KE FOTO
function apply() {
  if (!img.src) return;

  ctx.drawImage(img, 0, 0);

  const timeVal = document.getElementById("timeInput").value;
  const date = timeVal
    ? new Date(timeVal)
    : new Date();

  const jam = date.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });
  const tanggal = date.toLocaleDateString("id-ID");
  const hari = date.toLocaleDateString("id-ID", { weekday: "long" });

  ctx.fillStyle = "rgba(0,0,0,0.6)";
  ctx.fillRect(20, canvas.height - 260, canvas.width - 40, 240);

  ctx.fillStyle = "#fff";
  ctx.font = "90px Arial";
  ctx.fillText(jam, 40, canvas.height - 180);

  ctx.font = "22px Arial";
  ctx.fillText(`${tanggal} â€¢ ${hari}`, 40, canvas.height - 140);
  ctx.fillText(loc.addr || "-", 40, canvas.height - 110);
  ctx.fillText(
    `Koordinat: ${loc.lat?.toFixed(6) || "-"}, ${loc.lng?.toFixed(6) || "-"}`,
    40,
    canvas.height - 80
  );
}

// DOWNLOAD
function download() {
  const a = document.createElement("a");
  a.download = "timemark.png";
  a.href = canvas.toDataURL("image/png");
  a.click();
}
</script>
</body>
</html>
